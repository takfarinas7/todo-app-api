name: Build & Push Todo App API to GHCR

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    env:
      GHCR_IMAGE: ghcr.io/${{ github.repository_owner }}/todo-app-api
      # Utilisez le GITHUB_TOKEN standard, le plus sÃ©curisÃ©.
      GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
      
      # ðŸš¨ UTILISATION DES COMMANDES DE BUILD DU LISTING 2
      - name: 2. Compilation Maven (Listing 2)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - run: mvn clean package -DskipTests # Listing 2: tape de compilation

      # ðŸš¨ UTILISATION DES COMMANDES DOCKER DU LISTING 2 (ADAPTÃ‰ES)
      - name: 3. Build Docker & Login/Push
        run: |
          TAG=$(git rev-parse --short HEAD)
          IMAGE=${{ env.GHCR_IMAGE }}:$TAG
          
          # Login Docker (Listing 2: tape dâ€™authentification)
          echo ${{ env.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Build Docker (Listing 2: tape de Build Docker)
          docker build -t $IMAGE .
          
          # Push Docker (Listing 2: tape de Push Docker)
          docker push $IMAGE